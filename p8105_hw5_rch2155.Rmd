---
title: "P8105 Homework 5"
author: Rebekah Hughes
output: github_document
---


```{r setup, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

The raw data on homicides in US cities from the Washington Post includes information on homicide cases, including names of individuals killed, the name of the city and state, the coordinates of the homicide, date of report, and what the disposition was for each case. There is also an id variable for the case.

The following code creates a `city_state` variable and determines the number of unsolved and solved homicides within cities depending on disposition.

```{r}
homicide_df =
  read_csv("./hom-data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest" ~ "unsolved",
      disposition == "Closed by arrest" ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```


The following code chunks filter the data down to the homicides that are unsolved and run a proportion test to determine the proportion of homicides that are unsolved in Baltimore, MD specifically.

```{r}
aggregate_df =
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved),
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```


The following code determines the proportion of unsolved homicides in each city and pulls the confidence interval and the proportion from the data.

```{r}
results_df =
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```


The below code chunk creates a plot with the proportion of unsolved homicides and accompanying confidence intervals for each of the cities in the data.

```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```



## Problem 2


The data used for this problem contains information on individuals separated in the control or the experimental arms of a study. The individual data is contained in separate csv files. The following code brings the files together into one data frame and tidies the resulting data.

```{r}
path_df =
  tibble(
    path = list.files("lda-data/")
) %>% 
  mutate(path = str_c("lda-data/", path),
         data = map(path, read_csv)) %>% 
  unnest(data) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "observation") %>% 
  separate(path, c("data1", "data2", "arm", "subject_id", "file")) %>% 
  mutate(
    study_arm = case_when(
      arm == "con" ~ "control",
      arm == "exp" ~ "experimental"),
    week = as.numeric(week)) %>% 
  select(-data1, -data2, -file, -arm) %>% 
  relocate(study_arm)
```


The following plot uses the data frame created above to display observations on each subject over time. The plot is divided into the control arm and the experimental arm.

```{r}
path_df %>% 
  ggplot(aes(x = week, y = observation, color = subject_id)) +
  geom_line(size = 0.75) +
  facet_grid(. ~ study_arm)
```

Drawing from the above plot, the control group appears to have fairly stable observations over time. The experimental group, overall, appears to have increasing observations over time. Both of the study arms appear to start in a similar place with their observations and appear to diverge between weeks 2 and 3. The control group overall dips much lower than the experimental group ever does as well.  


## Problem 3



```{r}
sim_hyp_test = function(sampsize = 30, mu, sigma = 5){
  
  sim_data = 
    tibble(
      x = rnorm(n = sampsize, mean = mu, sd = sigma)
    )
  
  sim_data %>% 
    summarize(
     ttest = broom::tidy(t.test(x)))
}




output = vector("list", 5000)

for (i in 1:5000) {
  output[[i]] = sim_hyp_test(mu = 0)
}

sim_results = bind_rows(output)



sim_results = 
  tibble(mu = c(0, 1, 2, 3, 4, 5, 6)) %>% 
  mutate(
    output_lists = map(.x = mu, ~rerun(5000, sim_hyp_test(mu = .x))),
    estimate_dfs = map(output_lists, bind_rows)) %>% 
  select(-output_lists) %>% 
  unnest(estimate_dfs) %>% 
  mutate(mu_hat = ttest.estimate)



sim_results %>% 
  mutate(
    
    prop_reject = 
  )
  ggplot(aes(x = mu, y = mu_hat, fill = sample_size)) + 
  geom_violin()

```



```{r}

```



```{r}

```



```{r}

```

